name: Auto Redeploy Back4App (Enhanced)

on:
  schedule:
    - cron: "0 * * * *"   # æ¯å°æ—¶è¿è¡Œï¼Œå¯è‡ªè¡Œä¿®æ”¹
  workflow_dispatch:

jobs:
  redeploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30   # é˜²æ­¢ä»»åŠ¡æ— é™å¡ä½

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------
      # Playwright å®‰è£…ï¼ˆç‹¬ç«‹æ‹†åˆ†ï¼Œå¤±è´¥æ¦‚ç‡æ›´ä½ï¼‰
      # -----------------------------------
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Playwright
        run: pip install playwright

      - name: Install Chromium for Playwright
        run: playwright install --with-deps chromium

      # -----------------------------------
      # Retryï¼šå°è¯• 3 æ¬¡æ‰§è¡Œ main.py
      # -----------------------------------
      - name: Run redeploy script with retry
        env:
          BACK4APP_COOKIE: ${{ secrets.BACK4APP_COOKIE }}
          BACK4APP_EMAIL: ${{ secrets.BACK4APP_EMAIL }}
          BACK4APP_PASSWORD: ${{ secrets.BACK4APP_PASSWORD }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œ main.pyï¼ˆæœ€å¤šé‡è¯• 3 æ¬¡ï¼‰"

          attempts=0
          max_attempts=3

          until [ $attempts -ge $max_attempts ]
          do
            attempts=$((attempts+1))
            echo "ç¬¬ $attempts æ¬¡å°è¯•è¿è¡Œ main.py ..."

            python main.py && break

            echo "âŒ å¤±è´¥ï¼šmain.py ç¬¬ $attempts æ¬¡æ‰§è¡Œå¤±è´¥"
            echo "ç­‰å¾… 10 ç§’åé‡è¯•..."
            sleep 10
          done

          if [ $attempts -ge $max_attempts ]
          then
            echo "ğŸš¨ å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼šä»»åŠ¡å½»åº•å¤±è´¥"
            exit 1
          else
            echo "ğŸ‰ main.py æ‰§è¡ŒæˆåŠŸï¼"
          fi

      # -----------------------------------
      # ä¸Šä¼ é”™è¯¯æˆªå›¾åˆ° Artifactsï¼ˆä¾¿äºä½ æŸ¥çœ‹ï¼‰
      # -----------------------------------
      - name: Upload error screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-images
          path: |
            *.png
